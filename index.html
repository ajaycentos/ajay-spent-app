<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Spend Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day {
            aspect-ratio: 1 / 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border-radius: 8px; background-color: #f8fafc;
            font-size: 0.75rem; cursor: pointer; transition: background-color 0.2s;
            padding: 2px;
        }
        .calendar-day:hover { background-color: #f1f5f9; }
        .calendar-day.other-month { color: #cbd5e1; pointer-events: none; }
        .calendar-day.today { font-weight: bold; border: 2px solid #ef4444; }
        .calendar-day.selected { background-color: #fee2e2; border: 2px solid #dc2626; }
        .calendar-day .spend { font-size: 0.9rem; font-weight: 700; color: #ef4444; }
        #auth-overlay, #loader-overlay, #recurring-modal-overlay {
            background-color: rgba(241, 245, 249, 0.95);
            backdrop-filter: blur(8px);
        }
        .action-btn {
            background: none; border: none; padding: 4px; cursor: pointer;
            color: #94a3b8; transition: color 0.2s;
        }
        .action-btn:hover { color: #4f46e5; }
        .action-btn.delete:hover { color: #ef4444; }
        .category-tag {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 9999px;
            font-weight: 600;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-start justify-center min-h-screen pt-8 sm:pt-12">

    <main id="app-container" class="w-full max-w-md mx-auto p-4" style="display: none;">
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl font-bold text-slate-900">Daily Spend Tracker</h1>
            <p id="current-date" class="text-slate-500"></p>
            <div id="user-info" class="absolute top-0 right-0 text-right">
                <button id="logout-button" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold">Logout</button>
            </div>
        </header>

        <section id="total-spend-section" class="mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-md text-center">
                <p id="spend-header" class="text-sm font-medium text-slate-500 uppercase tracking-wider">Total Spent Today</p>
                <p id="total-spend-display" class="text-6xl font-bold mt-2 text-red-500">₹0</p>
            </div>
        </section>

        <div id="spend-page">
            <section id="add-spend-section">
                <h2 id="form-header" class="text-lg font-semibold mb-3 px-2">Log Expense</h2>
                <form id="add-spend-form" class="bg-white p-4 rounded-xl shadow-sm space-y-3">
                    <input type="number" id="spend-amount-input" placeholder="Amount (₹)" required class="w-full bg-slate-100 border border-slate-300 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                    <select id="spend-category-select" class="w-full bg-slate-100 border border-slate-300 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                        <option>Food</option>
                        <option>Transport</option>
                        <option>Shopping</option>
                        <option>Bills</option>
                        <option>Entertainment</option>
                        <option>Other</option>
                    </select>
                    <select id="spend-method-select" class="w-full bg-slate-100 border border-slate-300 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                        <option>UPI - CreditCard</option>
                        <option>UPI - Bank</option>
                        <option>CreditCard Swipe</option>
                        <option>Pluxee Card</option>
                        <option>Cash</option>
                    </select>
                    <input type="text" id="spend-comment-input" placeholder="Comment (optional)" class="w-full bg-slate-100 border border-slate-300 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                    <div class="flex gap-3">
                        <button type="button" id="cancel-edit-button" style="display: none;" class="flex-1 bg-slate-200 text-slate-700 font-semibold py-3 px-5 rounded-lg hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-2 transition">Cancel</button>
                        <button type="submit" id="submit-spend-button" class="flex-grow bg-red-600 text-white font-semibold py-3 px-5 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition shadow">Log Expense</button>
                    </div>
                </form>
            </section>
             <div class="text-center mt-4">
                <button id="manage-recurring-button" class="text-indigo-600 text-sm font-semibold hover:text-indigo-800">Manage Recurring</button>
            </div>
            
            <section id="search-section" class="mt-8">
                <input type="search" id="search-input" placeholder="Search all expenses..." class="w-full bg-white border border-slate-300 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition shadow-sm">
            </section>

            <section class="mt-6">
                <h2 id="spend-log-header" class="text-lg font-semibold mb-3 px-2">Today's Expenses</h2>
                <ul id="spend-log-list" class="space-y-2"></ul>
            </section>
        </div>

        <section id="calendar-section" class="mt-12">
            <h2 class="text-lg font-semibold mb-3 px-2">History</h2>
            <div class="bg-white p-4 rounded-2xl shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month" class="p-2 rounded-full hover:bg-slate-100">&lt;</button>
                    <h3 id="month-year" class="font-bold text-lg"></h3>
                    <button id="next-month" class="p-2 rounded-full hover:bg-slate-100">&gt;</button>
                </div>
                <div class="calendar-grid text-center text-xs font-semibold text-slate-500 mb-2">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-body" class="calendar-grid"></div>
            </div>
        </section>

        <section id="monthly-summary-section" class="mt-8" style="display: none;">
            <h2 class="text-lg font-semibold mb-3 px-2">Monthly Summary</h2>
            <div class="bg-white p-4 rounded-2xl shadow-md space-y-3 text-sm">
                <div class="flex justify-between items-center">
                    <span class="text-slate-500">Total Monthly Spend:</span>
                    <span id="total-monthly-spend" class="font-bold text-xl text-red-500">₹0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-slate-500">Average Daily Spend:</span>
                    <span id="avg-daily-spend" class="font-bold text-slate-700">₹0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-slate-500">Busiest Spending Day:</span>
                    <span id="top-spending-day" class="font-bold text-slate-700">--</span>
                </div>
                <hr>
                <div id="category-summary-container"></div>
            </div>
        </section>
        
        <footer class="text-center mt-8">
            <button id="reset-button" class="text-slate-500 text-sm hover:text-indigo-600">Reset today's data</button>
        </footer>
    </main>
    
    <div id="recurring-modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="w-full max-w-sm bg-white p-6 rounded-2xl shadow-xl space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Recurring Expenses</h2>
                <button id="close-recurring-modal-button" class="text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            
            <form id="add-recurring-form" class="space-y-2 p-3 bg-slate-50 rounded-lg">
                <p class="text-sm font-semibold">Add New</p>
                <input type="text" id="recurring-comment-input" placeholder="Expense Name (e.g., Rent)" required class="w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="number" id="recurring-amount-input" placeholder="Amount (₹)" required class="w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="number" id="recurring-day-input" placeholder="Day of Month (1-31)" required min="1" max="31" class="w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                 <select id="recurring-category-select" class="w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option>Bills</option><option>Entertainment</option><option>Food</option><option>Transport</option><option>Shopping</option><option>Other</option>
                </select>
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">Add Recurring</button>
            </form>

            <div>
                <p class="text-sm font-semibold mb-2">Existing</p>
                <ul id="recurring-list" class="space-y-2"></ul>
            </div>
        </div>
    </div>

    <div id="auth-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-xl text-center">
             <h2 class="text-2xl font-bold mb-2 text-slate-800">Welcome!</h2>
            <p class="text-slate-500 mb-6">Sign in to track your spending.</p>
            <div class="space-y-4">
                <button id="google-signin-button" class="w-full bg-white border border-slate-300 text-slate-700 font-semibold py-3 px-5 rounded-lg hover:bg-slate-50 transition flex items-center justify-center gap-3">
                    <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238A11.91 11.91 0 0 1 24 36c-5.222 0-9.618-3.226-11.283-7.662l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 35.24 44 30.025 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                    Sign in with Google
                </button>
                <p class="text-xs text-slate-400">or</p>
                <form id="email-form">
                    <input type="email" id="email-input" placeholder="Enter your email" required class="w-full bg-slate-100 border border-slate-300 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition mb-3">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-5 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition shadow">Continue with Email</button>
                </form>
            </div>
             <p id="auth-error" class="text-red-500 text-sm mt-4 h-4"></p>
        </div>
    </div>

    <div id="loader-overlay" class="fixed inset-0 z-50 flex items-center justify-center" style="display: none;">
        <div class="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
    </div>

    <script type="module">
        // --- SCRIPT VERSION 8.0 (SEARCH & PLUXEE CARD) ---
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
			apiKey: "AIzaSyD8rRXlt8gwrKMIgLTwhvejWCiIPOqEMl0",
            authDomain: "my-habit-tracker-fab33.firebaseapp.com",
            projectId: "my-habit-tracker-fab33",
            storageBucket: "my-habit-tracker-fab33.appspot.com",
            messagingSenderId: "76678091008",
            appId: "1:76678091008:web:beb64e97a88f1f04fa63e5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const appContainer = document.getElementById('app-container');
            const authOverlay = document.getElementById('auth-overlay');
            const loaderOverlay = document.getElementById('loader-overlay');
            const googleSigninButton = document.getElementById('google-signin-button');
            const emailForm = document.getElementById('email-form');
            const emailInput = document.getElementById('email-input');
            const authError = document.getElementById('auth-error');
            const logoutButton = document.getElementById('logout-button');
            const dateElement = document.getElementById('current-date');
            const totalSpendSection = document.getElementById('total-spend-section');
            const spendHeader = document.getElementById('spend-header');
            const totalSpendDisplay = document.getElementById('total-spend-display');
            const formHeader = document.getElementById('form-header');
            const addSpendSection = document.getElementById('add-spend-section');
            const addSpendForm = document.getElementById('add-spend-form');
            const spendAmountInput = document.getElementById('spend-amount-input');
            const spendCategorySelect = document.getElementById('spend-category-select');
            const spendMethodSelect = document.getElementById('spend-method-select');
            const spendCommentInput = document.getElementById('spend-comment-input');
            const submitSpendButton = document.getElementById('submit-spend-button');
            const cancelEditButton = document.getElementById('cancel-edit-button');
            const searchInput = document.getElementById('search-input');
            const calendarSection = document.getElementById('calendar-section');
            const spendLogHeader = document.getElementById('spend-log-header');
            const spendLogList = document.getElementById('spend-log-list');
            const resetButton = document.getElementById('reset-button');
            const monthYearElement = document.getElementById('month-year');
            const calendarBody = document.getElementById('calendar-body');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const monthlySummarySection = document.getElementById('monthly-summary-section');
            const totalMonthlySpend = document.getElementById('total-monthly-spend');
            const avgDailySpend = document.getElementById('avg-daily-spend');
            const topSpendingDay = document.getElementById('top-spending-day');
            const categorySummaryContainer = document.getElementById('category-summary-container');
            const manageRecurringButton = document.getElementById('manage-recurring-button');
            const recurringModalOverlay = document.getElementById('recurring-modal-overlay');
            const closeRecurringModalButton = document.getElementById('close-recurring-modal-button');
            const addRecurringForm = document.getElementById('add-recurring-form');
            const recurringCommentInput = document.getElementById('recurring-comment-input');
            const recurringAmountInput = document.getElementById('recurring-amount-input');
            const recurringDayInput = document.getElementById('recurring-day-input');
            const recurringCategorySelect = document.getElementById('recurring-category-select');
            const recurringList = document.getElementById('recurring-list');

            // --- APP STATE ---
            let spendHistory = {};
            let recurringExpenses = [];
            let calendarDate = new Date();
            let selectedDateStr = getTodayDateString();
            let currentUserId = null;
            let unsubscribeFromFirestore = null;
            let editingExpenseId = null; 
            const categoryColors = { 'Food': 'bg-red-100 text-red-800', 'Transport': 'bg-blue-100 text-blue-800', 'Shopping': 'bg-yellow-100 text-yellow-800', 'Bills': 'bg-purple-100 text-purple-800', 'Entertainment': 'bg-green-100 text-green-800', 'Other': 'bg-slate-200 text-slate-800'};

            // --- AUTHENTICATION & AUTHORIZATION ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    loaderOverlay.style.display = 'flex';
                    const isAuthorized = await checkAuthorization(user);
                    if (isAuthorized) { currentUserId = user.uid; authOverlay.style.display = 'none'; appContainer.style.display = 'block'; loadDataFromFirestore();
                    } else { loaderOverlay.style.display = 'none'; }
                } else { currentUserId = null; if (unsubscribeFromFirestore) unsubscribeFromFirestore(); spendHistory = {}; authOverlay.style.display = 'flex'; appContainer.style.display = 'none'; loaderOverlay.style.display = 'none'; }
            });
            const checkAuthorization = async (user) => { try { const docSnap = await getDoc(doc(db, "config", "whitelist")); if (docSnap.exists() && docSnap.data().allowedEmails?.includes(user.email)) return true; } catch(e) { console.error("Auth check error:", e); } authError.textContent = "You are not authorized."; signOut(auth); return false; };
            const actionCodeSettings = { url: window.location.href, handleCodeInApp: true };
            googleSigninButton.addEventListener('click', async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (error) { console.error("Google Sign-In Error:", error); authError.textContent = "Could not sign in with Google."; }});
            emailForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = emailInput.value; loaderOverlay.style.display = 'flex'; authError.textContent = ''; try { await sendSignInLinkToEmail(auth, email, actionCodeSettings); window.localStorage.setItem('emailForSignIn', email); alert(`A sign-in link has been sent to ${email}.`); } catch (error) { console.error("Email Sign-In Error:", error); authError.textContent = error.message; } finally { loaderOverlay.style.display = 'none'; }});
            logoutButton.addEventListener('click', () => { signOut(auth); });
            const handleEmailSignIn = async () => { if (isSignInWithEmailLink(auth, window.location.href)) { let email = window.localStorage.getItem('emailForSignIn') || window.prompt('Please provide your email for confirmation'); if (!email) return; loaderOverlay.style.display = 'flex'; try { await signInWithEmailLink(auth, email, window.location.href); window.localStorage.removeItem('emailForSignIn'); window.history.replaceState({}, document.title, window.location.pathname); } catch (error) { console.error("Email Link Sign-In Error:", error); authError.textContent = "Sign-in link is invalid or expired."; } finally { loaderOverlay.style.display = 'none'; }}};

            // --- FIRESTORE DATA HANDLING ---
            const loadDataFromFirestore = () => {
                if (!currentUserId) return;
                loaderOverlay.style.display = 'flex';
                const docRef = doc(db, "users", currentUserId);
                unsubscribeFromFirestore = onSnapshot(docRef, (docSnap) => {
                    let needsSave = false;
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        recurringExpenses = data.recurringExpenses || [];
                        if (data.spendHistory) { spendHistory = data.spendHistory; }
                        else if (data.habitHistory) { console.log("Old data found, migrating..."); const migratedData = {}; Object.keys(data.habitHistory).forEach(date => { migratedData[date] = { spendLog: data.habitHistory[date].spendLog || [] }; }); spendHistory = migratedData; needsSave = true; }
                        else { spendHistory = {}; }
                    } else { spendHistory = {}; recurringExpenses = []; }
                    if (!spendHistory[getTodayDateString()]) { spendHistory[getTodayDateString()] = { spendLog: [] }; needsSave = true; }
                    if (applyRecurringExpenses()) { needsSave = true; }
                    if (needsSave) { saveDataToFirestore(); }
                    renderRecurringList();
                    viewDate(selectedDateStr);
                    loaderOverlay.style.display = 'none';
                }, (error) => { console.error("Firestore read error:", error); loaderOverlay.style.display = 'none'; });
            };
            const saveDataToFirestore = async () => { if (!currentUserId) return; try { const docRef = doc(db, "users", currentUserId); await setDoc(docRef, { spendHistory, recurringExpenses, habitHistory: deleteField() }, { merge: true }); } catch (error) { console.error("Error saving data to Firestore: ", error); alert("Error: Could not save data."); }};

            // --- DATE HELPERS ---
            function getTodayDateString() { const today = new Date(); return `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`; }
            function formatDateForDisplay(dateStr) { const date = new Date(dateStr + 'T00:00:00'); return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' }); }

            // --- CORE LOGIC & CRUD OPERATIONS ---
            const calculateTotalSpend = (spendLog) => (!spendLog ? 0 : spendLog.reduce((sum, entry) => sum + entry.amount, 0));
            const addSpend = (dateStr, amount, category, method, comment, isRecurring = false, recurringId = null) => { if (!spendHistory[dateStr]) spendHistory[dateStr] = { spendLog: [] }; const time = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit'}); spendHistory[dateStr].spendLog.push({ id: Date.now(), amount, category, method, comment, time, isRecurring, recurringId }); saveDataToFirestore(); viewDate(selectedDateStr); };
            const updateSpend = (dateStr, expenseId, newData) => { const log = spendHistory[dateStr]?.spendLog; if (!log) return; const expenseIndex = log.findIndex(e => e.id === expenseId); if (expenseIndex > -1) { log[expenseIndex] = { ...log[expenseIndex], ...newData }; saveDataToFirestore(); viewDate(selectedDateStr); }};
            const deleteSpend = (dateStr, expenseId) => { const log = spendHistory[dateStr]?.spendLog; if (!log) return; spendHistory[dateStr].spendLog = log.filter(e => e.id !== expenseId); saveDataToFirestore(); viewDate(selectedDateStr); };

            // --- RECURRING EXPENSE LOGIC ---
            const applyRecurringExpenses = () => { let changed = false; const today = new Date(); const currentMonth = today.getMonth(); const currentYear = today.getFullYear(); recurringExpenses.forEach(expense => { const expenseDate = new Date(currentYear, currentMonth, expense.day); if (expenseDate <= today) { const dateStr = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${expense.day.toString().padStart(2, '0')}`; if (!spendHistory[dateStr]) spendHistory[dateStr] = { spendLog: [] }; if (!spendHistory[dateStr].spendLog.some(e => e.recurringId === expense.id)) { console.log(`Applying recurring expense: ${expense.comment}`); addSpend(dateStr, expense.amount, expense.category, 'Auto', expense.comment, true, expense.id); changed = true; } } }); return changed; };
            
            // --- UI & RENDERING ---
            const startEditMode = (expenseId) => { const expense = spendHistory[selectedDateStr]?.spendLog.find(e => e.id === expenseId); if (!expense) return; editingExpenseId = expenseId; spendAmountInput.value = expense.amount; spendCategorySelect.value = expense.category || 'Other'; spendMethodSelect.value = expense.method; spendCommentInput.value = expense.comment; formHeader.textContent = "Edit Expense"; submitSpendButton.textContent = "Update Expense"; submitSpendButton.classList.replace('bg-red-600', 'bg-indigo-600'); cancelEditButton.style.display = 'block'; };
            const cancelEditMode = () => { editingExpenseId = null; addSpendForm.reset(); formHeader.textContent = "Log Expense"; submitSpendButton.textContent = "Log Expense"; submitSpendButton.classList.replace('bg-indigo-600', 'bg-red-600'); cancelEditButton.style.display = 'none'; };
            
            const calculateAndDisplayMonthlySummary = (year, month) => {
                let totalSpend = 0, daysWithExpenses = 0, topDay = { date: null, amount: 0 }; const categoryTotals = {};
                for (let i = 1; i <= new Date(year, month + 1, 0).getDate(); i++) {
                    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                    if (spendHistory[dateStr]?.spendLog.length > 0) {
                        let dailyTotal = 0;
                        spendHistory[dateStr].spendLog.forEach(entry => { dailyTotal += entry.amount; const category = entry.category || 'Other'; categoryTotals[category] = (categoryTotals[category] || 0) + entry.amount; });
                        totalSpend += dailyTotal; daysWithExpenses++;
                        if (dailyTotal > topDay.amount) { topDay = { date: dateStr, amount: dailyTotal }; }
                    }
                }
                const avgSpend = daysWithExpenses > 0 ? (totalSpend / daysWithExpenses) : 0;
                totalMonthlySpend.textContent = `₹${Math.round(totalSpend)}`; avgDailySpend.textContent = `₹${Math.round(avgSpend)}`; topSpendingDay.textContent = topDay.date ? `Day ${new Date(topDay.date + 'T00:00:00').getDate()} (₹${topDay.amount})` : '--';
                categorySummaryContainer.innerHTML = ''; const sortedCategories = Object.entries(categoryTotals).sort(([,a],[,b]) => b-a);
                if (sortedCategories.length > 0) { sortedCategories.forEach(([category, amount]) => { const div = document.createElement('div'); div.className = 'flex justify-between items-center'; div.innerHTML = `<span class="flex items-center gap-2"><span class="category-tag ${categoryColors[category] || categoryColors['Other']}">${category}</span></span><span class="font-semibold">₹${Math.round(amount)}</span>`; categorySummaryContainer.appendChild(div); });
                } else { categorySummaryContainer.innerHTML = '<p class="text-slate-400 text-center">No expenses to categorize this month.</p>'; }
                monthlySummarySection.style.display = 'block';
            };

            const renderSpendLog = (spendLog, isSearchResult = false) => {
                spendLogList.innerHTML = '';
                if (!spendLog || spendLog.length === 0) { spendLogList.innerHTML = `<p class="text-center text-slate-500 p-4">No expenses found.</p>`; return; }
                spendLog.forEach(entry => { // No reverse for search results
                    const li = document.createElement('li');
                    li.className = `bg-white p-3 rounded-lg flex justify-between items-start gap-2 ${entry.isRecurring ? 'opacity-70 border-l-4 border-indigo-300' : ''}`;
                    const category = entry.category || 'Other';
                    const dateDisplay = isSearchResult ? `<p class="text-xs font-semibold text-indigo-600 mb-1">${formatDateForDisplay(entry.date)}</p>` : '';
                    li.innerHTML = `
                        <div class="flex-grow">
                            ${dateDisplay}
                            <div class="flex justify-between items-start"><span class="font-bold text-lg text-red-600">₹${entry.amount}</span><span class="category-tag ${categoryColors[category] || categoryColors['Other']}">${category}</span></div>
                            <p class="text-slate-600 text-sm mt-1">${entry.comment || '&nbsp;'}</p>
                            <p class="text-right text-xs text-slate-400 mt-1">${entry.isRecurring ? 'Auto-logged' : entry.time} &bull; ${entry.method}</p>
                        </div>
                        <div class="flex flex-col">
                            ${!entry.isRecurring ? `<button title="Edit" class="action-btn edit-btn" data-id="${entry.id}" data-date="${entry.date}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>` : ''}
                            <button title="Delete" class="action-btn delete-btn delete" data-id="${entry.id}" data-date="${entry.date}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                        </div>`;
                    spendLogList.appendChild(li);
                });
            };

            const renderRecurringList = () => {
                recurringList.innerHTML = '';
                if (recurringExpenses.length === 0) { recurringList.innerHTML = `<p class="text-center text-slate-500 text-xs p-2">No recurring expenses set.</p>`; return; }
                recurringExpenses.forEach(exp => { const li = document.createElement('li'); li.className = 'bg-white p-2 rounded-lg flex justify-between items-center text-sm'; li.innerHTML = `<div><p class="font-semibold">${exp.comment} - <span class="text-red-600">₹${exp.amount}</span></p><p class="text-xs text-slate-500">Day ${exp.day} of each month &bull; ${exp.category}</p></div><button class="action-btn delete-recurring-btn delete" data-id="${exp.id}">&times;</button>`; recurringList.appendChild(li); });
            };

            const renderCalendar = () => {
                calendarBody.innerHTML = ''; const year = calendarDate.getFullYear(); const month = calendarDate.getMonth();
                monthYearElement.textContent = calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDay; i++) { calendarBody.insertAdjacentHTML('beforeend', `<div class="calendar-day other-month"></div>`); }
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayCell = document.createElement('div'); const dayDate = new Date(year, month, i);
                    const dateStr = `${dayDate.getFullYear()}-${(dayDate.getMonth() + 1).toString().padStart(2, '0')}-${dayDate.getDate().toString().padStart(2, '0')}`;
                    dayCell.className = 'calendar-day'; dayCell.dataset.date = dateStr;
                    if (dateStr === getTodayDateString()) dayCell.classList.add('today'); if (dateStr === selectedDateStr) dayCell.classList.add('selected');
                    let spendHtml = ''; if (spendHistory[dateStr]) { const totalSpend = calculateTotalSpend(spendHistory[dateStr].spendLog); if (totalSpend > 0) { spendHtml = `<span class="spend">₹${totalSpend}</span>`; }}
                    dayCell.innerHTML = `<span>${i}</span>${spendHtml}`; calendarBody.appendChild(dayCell);
                }
                calculateAndDisplayMonthlySummary(year, month);
            };

            const viewDate = (dateStr) => {
                if(editingExpenseId) cancelEditMode();
                searchInput.value = '';
                toggleSearchView(false);
                selectedDateStr = dateStr;
                const dataForDay = spendHistory[dateStr] || { spendLog: [] };
                renderSpendLog(dataForDay.spendLog.slice().reverse()); // Pass a reversed copy
                resetButton.style.display = (dateStr === getTodayDateString()) ? 'block' : 'none';
                renderCalendar();
            };
            
            const toggleSearchView = (isSearching) => {
                addSpendSection.style.display = isSearching ? 'none' : 'block';
                totalSpendSection.style.display = isSearching ? 'none' : 'block';
                calendarSection.style.display = isSearching ? 'none' : 'block';
                monthlySummarySection.style.display = isSearching ? 'none' : 'block';
                manageRecurringButton.style.display = isSearching ? 'none' : 'block';
                if (isSearching) {
                    spendLogHeader.textContent = "Search Results";
                } else {
                    const isToday = selectedDateStr === getTodayDateString();
                    spendHeader.textContent = isToday ? "Total Spent Today" : `Total Spent on ${formatDateForDisplay(selectedDateStr)}`;
                    spendLogHeader.textContent = isToday ? "Today's Expenses" : `Expenses for ${formatDateForDisplay(selectedDateStr)}`;
                }
            };
            
            // --- EVENT LISTENERS ---
            addSpendForm.addEventListener('submit', (e) => { e.preventDefault(); const amount = parseInt(spendAmountInput.value); const category = spendCategorySelect.value; const method = spendMethodSelect.value; const comment = spendCommentInput.value; if (!amount || amount <= 0) return; if (editingExpenseId) { updateSpend(selectedDateStr, editingExpenseId, { amount, category, method, comment }); } else { addSpend(selectedDateStr, amount, category, method, comment); } cancelEditMode(); });
            spendLogList.addEventListener('click', (e) => { const editBtn = e.target.closest('.edit-btn'); const deleteBtn = e.target.closest('.delete-btn'); const date = editBtn?.dataset.date || deleteBtn?.dataset.date || selectedDateStr; if (editBtn) { selectedDateStr = date; startEditMode(parseInt(editBtn.dataset.id)); } else if (deleteBtn) { if (confirm("Delete this expense?")) { deleteSpend(date, parseInt(deleteBtn.dataset.id)); if (searchInput.value) searchInput.dispatchEvent(new Event('input')); } }});
            cancelEditButton.addEventListener('click', cancelEditMode);
            calendarBody.addEventListener('click', (e) => { const dayCell = e.target.closest('.calendar-day'); if (dayCell?.dataset.date) { viewDate(dayCell.dataset.date); }});
            resetButton.addEventListener('click', () => { if (confirm("Are you sure?")) { if(spendHistory[getTodayDateString()]) { spendHistory[getTodayDateString()].spendLog = []; saveDataToFirestore(); } }});
            prevMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
            nextMonthBtn.addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });
            manageRecurringButton.addEventListener('click', () => { recurringModalOverlay.style.display = 'flex'; });
            closeRecurringModalButton.addEventListener('click', () => { recurringModalOverlay.style.display = 'none'; });
            addRecurringForm.addEventListener('submit', (e) => { e.preventDefault(); const newRecurring = { id: Date.now(), comment: recurringCommentInput.value, amount: parseInt(recurringAmountInput.value), day: parseInt(recurringDayInput.value), category: recurringCategorySelect.value, }; recurringExpenses.push(newRecurring); saveDataToFirestore(); renderRecurringList(); addRecurringForm.reset(); });
            recurringList.addEventListener('click', (e) => { const deleteBtn = e.target.closest('.delete-recurring-btn'); if (deleteBtn && confirm('Delete this recurring expense?')) { recurringExpenses = recurringExpenses.filter(exp => exp.id !== parseInt(deleteBtn.dataset.id)); saveDataToFirestore(); renderRecurringList(); }});
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase().trim();
                if (!query) { viewDate(selectedDateStr); return; }
                toggleSearchView(true);
                let results = [];
                Object.keys(spendHistory).forEach(date => {
                    spendHistory[date].spendLog.forEach(expense => {
                        if (expense.comment?.toLowerCase().includes(query) || expense.category?.toLowerCase().includes(query) || expense.amount.toString().includes(query)) {
                            results.push({ ...expense, date });
                        }
                    });
                });
                results.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderSpendLog(results, true);
            });

            // --- INITIALIZATION ---
            const displayDate = () => { dateElement.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }); };
            displayDate();
            handleEmailSignIn();
        });
    </script>
</body>
</html>
